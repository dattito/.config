#:schema https://jj-vcs.github.io/jj/latest/config-schema.json

[user]
name = "dattito"
email = "32016658+dattito@users.noreply.github.com"

[ui]
default-command =["log", "--limit", "10"]

[signing]
behavior = "drop"
backend = "ssh"
key = "~/.ssh/dattito02_ed25519.pub"

[git]
sign-on-push = true

[aliases]
i = ["git", "init"]
l = ["log", "--limit", "10"]
la = ["log", "-r", "all()"]
lm = ["log", "-r", "main-..@"]
gp = ["git", "push", "-b"]
c = ["commit"]
gc = ["git", "clone"]
d = ["describe"]
n = ["new"]
f = ["git", "fetch"]
ps = ["util", "exec", "--", "bash", "-c", """
set -e

# Check if current commit has both description and changes
has_description=$(jj log -r @ --no-graph --color never -T 'description' | grep -q . && echo "yes" || echo "no")
# Use 'empty' template keyword to check if commit has changes
has_changes=$(jj log -r @ --no-graph --color never -T 'empty' | grep -q "false" && echo "yes" || echo "no")

if [ "$has_description" = "yes" ] && [ "$has_changes" = "yes" ]; then
    echo "Current commit has description and changes, creating new commit..."
    jj new
fi

# Get the bookmark from the parent commit directly
bookmark=$(jj log -r 'ancestors(@) & bookmarks()' -n 1 --no-graph --color never -T 'bookmarks' | sed 's/\\*$//' | tr -d ' ')

if [ -z "$bookmark" ]; then
    echo "No bookmark found on parent commit"
    exit 1
fi

echo "Moving bookmark '$bookmark' to parent commit and pushing..."
jj bookmark set "$bookmark" -r @-
jj git fetch
jj git push --bookmark "$bookmark" --allow-new
"""]

[templates]
log_node = '''
if(self && !current_working_copy && !immutable && !conflict && in_branch(self),
  "â—‡",
  builtin_log_node
)
'''

[template-aliases]
"in_branch(commit)" = 'commit.contained_in("immutable_heads()..bookmarks()")'
"format_timestamp(timestamp)" = "timestamp.ago()"

[[--scope]]
--when.commands = ["diff", "show"]
[--scope.ui]
pager = "delta"
diff-formatter = ":git"

[[--scope]]
--when.repositories = [
  "~/repositories/sap"
]
[--scope.user]
name = "David Siregar"
email = "david.siregar@sap.com"
[--scope.templates]
# Each line in the multi-line string is a trailer.
# The template language allows you to construct strings and use built-in functions.
commit_trailers = '''
concat("On-behalf-of: ", committer.name(), " <", committer.email(), ">", "\n")
++ format_signed_off_by_trailer(self)
'''
